#!/usr/bin/env bash

set -evo
source /opt/tripleo/venv/bin/activate

export TRIPLEO_ROOT=/opt/tripleo

sudo chown -R $(whoami):$(whoami) /opt/tripleo

{% set packages = [] %}
{% for patch in tripleo_developer_patches %}
{%   if not (patch.install_in_venv | default(false) | bool) %}
{%     set _ = packages.append('--package-name ' ~ (patch.url | basename) ~ ' ') %}
{%   endif %}
{% endfor %}

pushd /opt/tripleo/DLRN
    if [[ ! -f "/opt/tripleo/packages.created" ]]; then
        sudo find /opt/tripleo/rpms/ -name '*rpm' -exec rm -f {}  \;
        sudo /opt/tripleo/venv/bin/dlrn --config-file /opt/tripleo/DLRN/projects.ini \
                                        --head-only \
                                        {{ packages | join( ) }} \
                                        --local \
                                        --info-repo /opt/tripleo/rdoinfo \
                                        --dev &> /opt/tripleo/packages.log || exit 99
        sudo touch /opt/tripleo/packages.created
        export RPMS="$(find /opt/tripleo/data/ -name '*.rpm' ! -name '*src.rpm')"
        sudo mv ${RPMS} /opt/tripleo/rpms/
    fi
popd

set +evo

if [[ ! -z "${RPMS}" ]]; then
    echo -e "Installing RPMS"
    sudo $(command -v dnf || command -v yum) -y install /opt/tripleo/rpms/*.rpm
fi
