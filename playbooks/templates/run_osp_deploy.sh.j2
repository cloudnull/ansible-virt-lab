#!/usr/bin/env bash

export THT="/usr/share/openstack-tripleo-heat-templates"

tmux new-session -d -s undercloud -n undercloud || true
tmux new-window -n deploy -t 0 || true
tmux new-window -n glances -t 1 || true
tmux select-window -t 1
tmux send-keys "/opt/rdo/bin/glances --disable-autodiscover --diskio-iops --diskio-show-ramfs --enable-irq" C-m
tmux select-window -t 0
tmux send-keys "openstack undercloud install" C-m
tmux send-keys "source ~/stackrc" C-m
tmux send-keys "openstack subnet set ctlplane-subnet --dns-nameserver {{ redhat_dns_servers[0] }}" C-m
tmux send-keys "pushd ~/images" C-m
tmux send-keys "openstack overcloud image upload --update-existing" C-m
tmux send-keys "popd" C-m
tmux send-keys "openstack tripleo container image prepare -e local_images.yaml --output-env-file containers-prepare-parameters.yaml" C-m
tmux send-keys "openstack overcloud node import vm-instackenv.yaml" C-m
tmux send-keys "openstack overcloud node introspect --all-manageable --provide --concurrency {{ (ansible_processor_vcpus | int) * 2  }} || openstack overcloud node introspect --all-manageable --provide" C-m
{% for item in target_nodes %}
{%   if 'capabilities' in item %}
tmux send-keys "openstack baremetal node set --property {{ item['capabilities'] }} {{ item['name'] }}" C-m
{%   endif %}
{% endfor %}
{% set environments = ['$THT/environments/enable-swap.yaml'] %}
{% if (rh_it_ca_stat.stat.exists | bool) %}
{%   set _ = environments.append('$THT/environments/ssl/inject-trust-anchor.yaml') %}
{% endif %}
{% set _ = environments.append('$THT/environments/disable-telemetry.yaml') %}
{% set _ = environments.append('$THT/environments/docker-ha.yaml') %}
{% set _ = environments.append('$THT/environments/podman.yaml') %}
{% set _ = environments.append('$THT/environments/services/neutron-ovn-ha.yaml') %}
{% set _ = environments.append('containers-prepare-parameters.yaml') %}
{% set _ = environments.append('params.yaml') %}
tmux send-keys "openstack overcloud deploy --templates $THT/ -e {{ environments | join(' -e ') }} --timeout 100" C-m

echo -e "Stack creation has been initiated."
